# 3 - 光栅图像

大多数计算机图形图像以某种光栅显示呈现给用户。光栅显示器将图像显示为矩形像素阵列，它有一个矩形的小发光像素阵列，可以单独设置为不同的颜色以创建任何所需的图像。不同的颜色是通过混合不同强度的红光、绿光和蓝光来实现的。

> 大多数打印机，如激光打印机和喷墨打印机，也是光栅设备。
> 它们是基于扫描的：没有物理上的像素格，而是通过在网格上选定点沉积墨水来顺序绘制图像。

光栅在图像输入设备中也很流行。数码相机包含一个由光敏像素组成的图像传感器，每个像素记录落在它上面的光的颜色和强度。桌面扫描仪包含一个像素的线性阵列，它扫过待扫描的页面，每秒进行多次测量以产生像素网格。

光栅图像是存储和处理图像的常见类型。光栅图像只是一个二维数组，它存储每个像素的像素值——通常是颜色，存储为三个数字，分别是红、绿和蓝。可以使用存储器中图像的像素值来控制显示器上像素的值。

有时我们可能想要改变图像的大小或方向，校正颜色，甚至粘贴在移动的三维表面上。即使在电视中，显示器的像素也很少与所显示的图像相同。像这样的考虑打破了图像像素和显示像素之间的直接联系。最好将光栅图像视为与设备无关的数据结构，而显示设备则是呈现该图像的近似方式。

还有其他描述图像的方法。矢量图像是存储形状描述的数据结构·——由线或曲线包围的颜色区域构成——而不参考任何特定的像素网格。实际上，这相当于存储显示图像的指令，而不是显示图像所需的像素。
矢量图像的主要优点是它们与分辨率无关，可以在非常高分辨率的设备上很好地显示。相应的缺点是，在显示之前必须对它们进行光栅化。矢量图像通常用于文本，图表，机械图纸和其他应用程序，其中清晰度和精度很重要，而不需要摄影图像和复杂的阴影。

## 3.1 光栅设备

一些熟悉的光栅设备可以分为一个简单的层次结构：

- 输出
  - 显示
    - 透射式：液晶显示 LCD
    - 放射式：发光二极管显示器 LED
  - 硬拷贝
    - 二进制：喷墨打印机
    - 连续色调：染料升华打印机
- 输入
  - 2D 阵列传感器：数码相机
  - 1D 阵列传感器：平板扫描仪

### 3.1.1 显示

目前的显示器，包括电视和数字电影放映机，以及计算机的显示器和投影仪，几乎都是基于固定的像素阵列。它们可以分为放射式显示器和透射式显示器：

1. 放射式显示器使用直接发射可控光量的像素。
   透射式显示器需要光源照明：在直视显示器中，这是阵列后面的背光；在投影仪中，它是一盏灯，它发出的光在穿过阵列后投射到屏幕上。
1. 透射式显示器像素本身不发光，而是改变它们允许通过的光量。发射显示器的光源是他自己。

发光二极管(LED)显示器就是放射式的一个例子。每个像素由一个或多个 LED 组成，这些 LED 是半导体器件(基于无机或有机半导体)，其发光强度与通过它们的电流有关。

彩色显示器中的像素分为三个独立控制的子像素——红色，绿色，蓝色——子像素由不同的材料构成使得他们可以发出不同的光线。当从远处观看显示器时，眼睛无法分离各个亚像素，所感知的颜色是红、绿和蓝的混合。

液晶显示器(LCD)是透射型的一个例子。液晶是一种材料，其分子结构使其能够旋转穿过它的光的偏振，旋转程度可以通过施加电压来调节。LCD 像素在其后面有一层偏振膜，它能被偏振光照亮（假设它只透射水品偏振的光）。
![](pic/Pasted%20image%2020240229093608.png)
像素前面的第二层偏振膜只透射垂直偏振的光。如果施加的电压设置得使中间的液晶层不改变偏振，所有的光都被阻挡，像素处于“关闭”状态（最小强度）状态。如果将电压设置为使得液晶将偏振旋转 90 °，那么所有通过像素背面进入的光将通过正面发射出，像素完全“打开”——它具有最大强度。中间电压将部分地旋转偏振，使得前偏振器部分地阻挡光，导致强度介于最小和最大之间。
与彩色 LED 显示器一样，彩色 LCD 的每个像素内都有红色、绿色和蓝色子像素，这是三个独立的像素，上面有红色、绿色和蓝色滤色器。

### 3.1.2 硬拷贝设备

在纸上永久记录图像的过程与在显示器上暂时显示图像的过程有非常不同的限制。在打印中，颜料分布在纸或其他介质上，以便当光从纸上反射时形成所需的图像。打印机是像显示器一样的光栅设备，但许多打印机只能打印二进制图像——颜料要么沉积在每个网格位置，要么不在，不可能有中间量。

喷墨打印机是通过扫描形成光栅图像的设备的一个例子。喷墨打印头含有携带颜料的液体墨水，它可以在电子控制下以非常小的液滴喷洒。喷头在纸上移动时，墨滴在经过应该接收墨水的网格位置时被释放出来；墨水不会排出在打算留白的区域。每次扫描后，纸张略微前进，然后，网格的下一行被绘制。彩色打印是通过使用几个打印头来进行的，每个喷墨墨水带有不同的颜料，因此每个网格位置可以接收不同颜色的液滴的任意组合。
喷墨打印机没有像素的物理阵列；分辨率取决于每次扫描后液滴的大小和纸张前进的距离。许多喷墨打印机在打印头上有多个喷嘴，使得一次扫描可以进行几次扫描，但最终决定行间距的是纸张推进，而不是喷嘴间距。

热染料转移过程是连续色调打印过程的一个例子，这意味着可以在每个像素处沉积不同量的染料。包含有色染料的供体色带被压在纸或染料接收器和包含加热元件的线性阵列的打印头之间，每列像素对应一个加热元件。当纸和色带经过头时，加热元件接通和关闭以在需要染料的区域加热色带，使染料从色带扩散到纸张。对于几种染料中的每一种都重复这一过程。较高的温度可以使更多的染料被转移，所以可以控制在每个网格位置沉积的每种染料的量，允许产生连续的颜色范围。打印机中的加热元件的数量确保了在整个页面方向上的固定分辨率，但沿着页面的分辨率是由与纸张的速度相比的加热和冷却的速度来确定的。

与显示器不同，打印机的分辨率是用像素密度而不是像素总数来描述的。

1. 热染料转印打印机：在其打印头上每英寸间隔 300 个元素在页面上的分辨率为 300 像素/英寸(PPI)。如果沿页面的分辨率相同，我们可以简单地说打印机的分辨率为 300 ppi。
2. 喷墨打印机：将点放置在每英寸 1200 个网格点的网格上的喷墨打印机被描述为具有每英寸 1200 个点(Dpi)的分辨率。

> 术语‘dpi’经常被用来指‘每英寸像素数’，但 dpi 指的是二进制设备，ppi 指的是连续色调设备。

由于喷墨打印机是二进制设备，至少出于两个原因，它需要更精细的网格。由于边缘是陡峭的黑/白边界，因此需要非常高的分辨率以避免出现阶跃或混叠伪影。当打印连续色调图像时，需要高分辨率来通过打印的不同密度的网点图案来模拟中间色（半色调）。

### 3.1.3 输入设备

任何不是通过算法计算的图像都必须由某个光栅输入设备测量，通常是照相机或扫描仪。即使在渲染 3D 场景的图像时，照片也经常被用作纹理贴图。光栅输入设备必须对每个像素进行光测量，和输出设备一样，它们通常基于传感器阵列。

数码相机是 2D 阵列输入设备的一个例子。相机中的图像传感器是具有光敏像素网格的半导体设备。两种常见的阵列称为 CCDs(电荷耦合器件)和 CMOS(自由的金属氧化物半导体)图像传感器。相机的透镜将要拍摄的场景的图像投射到传感器上，然后每个像素测量落在它上面的光能，最终产生图像的数值表示。与彩色显示器使用 rgb 亚像素一样，大多数彩色相机的工作原理是使用滤色器阵列或马赛克，使每个像素只能看到红色、绿色或蓝色的光，让图像处理软件填充缺失的值（去马赛克）。
![](pic/Pasted%20image%2020240229113733.png)
其他相机使用三个单独的阵列，或阵列中的三个单独的层，以测量每个像素上独立的红、绿和蓝值。相机的分辨率由阵列中固定的像素数决定，通常使用总像素数：具有 3000 列和 2000 行阵列的相机产生分辨率为 3000 x 2000 的图像，它有 600 万像素，称 6 megapixel（MP）。然而，马赛克传感器不能测量完整的彩色图像，能够以相同分辨率独立记录 rgb 的相机能采集相比于马赛克相机更多的信息。

平板扫描仪也测量红、绿、蓝和蓝色值，但就像热敏染料转印打印机一样，它使用一维阵列扫描页面，每秒进行多次测量。页面上的横跨分辨率由阵列的大小固定，页面上的纵向分辨率由测量频率与扫描头移动速度相比确定。彩色扫描仪具有 3×N 阵列，其中 N 是页面上横跨的像素数，三行由红色、绿色和蓝色滤光片覆盖。在测量三种颜色的时间之间有适当的延迟，这允许在每个网格点上进行三个独立的颜色测量。与连续色调打印机一样，扫描仪的分辨率以每英寸像素(PPI)为单位报告

## 3.2 图像、像素以及几何

当我们测量或复制图像时，它们采用光能二维分布的形式：从显示器发出的光作为表面位置的函数；投射在相机传感器上的光是传感器平面上位置的函数；反射率，或光线被反射的分数(相对于吸收)作为位置的函数。因此在物理世界中，图像是在二维区域上定义的函数——几乎总是矩形。因此我们可以将图像抽象为函数，其中 R 是矩形区域，V 是可能的像素值的集合。
$$I(x,y):R\to V$$
光栅图像如何与连续图像的这个抽象概念相关联？
看具体的例子，来自照相机或扫描仪的像素是图像在像素周围的一些小区域上的平均颜色的量度。显示像素（有红色、绿色和蓝色子像素）的设计使得像素表面上图像的平均颜色由相应的像素值控制。在这两种情况下，像素值是图像颜色的局部平均，它被称为图像的点样本。换句话说，当我们在一个像素中找到值 x 时，它意味着在该网格点附近的值为 x。

> 在一些 APIs 中图像的 Y 轴是朝下的，这意味着（0，0）点位于左上角。

像素在 2D 空间中的位置分布如何（这是习惯问题）？本书中，光栅图像是由表示像素列和行的索引对表示的，从左下角开始计数。如果图像有 Nx 列和 Ny 行像素，左下角是(0，0)，右上角是像素(n-1，NY-1)。我们需要 2D 屏幕坐标来指定像素位置，我们将把像素的采样点放在整数坐标上。
![](pic/Pasted%20image%2020240229135608.png)
图像的矩形区域具有宽度 Nx 和高度 Ny，并以此网格为中心，这意味着它在每边最后一个采样点之外延伸半个像素。因此图像的域是：$R=[-0.5,n_x-0.5]\times[-0.5,n_y-0.5]$。

再次提醒，这些坐标是仅是为了方便，但在以后实现相机和查看变换时，它们是很重要的。

### 3.2.1 像素值

到目前为止，我们已经用实数来描述像素值，并表示图像中某一点的强度(红色、绿色和蓝色是分开的)。图像应该是存储浮点数的数组，存储 1 位或者 3 位 32bit 的浮点数根据灰度图和彩色图来划分。当需要精度和取值范围时，有时会使用这种格式，但图像有很多像素，存储和传输图像的内存和带宽总是稀缺的。

> 为什么一张 1000 万像素的照片就会以这种格式消耗大约 115 MB 的 RAM?
> 10M 像素 3 颜色 4B 浮点数 = 120MB
> 因为有压缩吧。。。

直接显示图像所需的范围较小。然而可能的光线强度却在原则上没有上限，但任何给定的设备都有一个绝对有限的最大强度，因此在许多情况下，像素有一个有限的范围就足够了，通常被简单地认为是 0 和 1。

> 以浮点数存储的图像通常称为高动态范围(HDR)图像，以区别于以整数存储的固定范围或低动态范围(LDR)图像。

以下是一些具有典型应用的像素格式：

1. 1-bit 灰度，无中间值。
2. 8-bit RGB 固定范围色彩（总共 24bit）：网页和邮件应用、消费级照片。
3. 8 to 10-bit 固定范围 RGB（总共 24-30bit）：电脑的数字界面。
4. 12 to 14-bit 固定范围 RGB（总共 36-42bit）：专业摄影相机的 RAW 图像。
5. 16-bit RGB 固定范围色彩（总共 48bit）：专业摄像机和打印机，用于固定范围图像的图像处理的中间格式。
6. 16-bit 固定范围灰度图（总共 48bit）：放射学和医学成像。
7. 16bit 半精度浮点 RGB：HDR 图像，用于实时渲染的中间格式。
8. 32bit 浮点 RGB：用于 HDR 图像的软件渲染和处理的通用中间格式。

减少存储的比特数会导致图像中两种不同类型的伪影（或称人为引入的缺陷）：

1. 首先，当超过可表示的最大值的亮度出现时，使用固定范围值的图像会产生裁剪（钳制到最大值）。例如，晴天场景的照片可能包括比白色表面更亮的射线，当图像转换为要显示的固定范围时，他们将被裁剪（即使它们由相机测量）。
2. 其次，当需要将像素值四舍五入到最接近的可表示值时，编码精度有限的图像会导致量化伪影或条带化。

### 3.2.2 显示强度与 Gamma 矫正

所有现代显示器都采用数字输入作为像素的“值”，并将其转换为强度 Level。显示器在关闭时也具有一些非零强度得光线，因为屏幕会反射一些光。我们假设像素颜色的数值描述范围从 0 到 1。黑色和白色中间的灰色是 0.5。

> 这里的“一半”指的是显示器发出的物理光量，而不是看上去的“中灰”。
> 人眼认为的"中灰"大致对应显示光量的 0.18，人类对强度的感知是非线性的。

要在显示器上产生正确的图像，必须了解的关键问题：监视器相对于输入是非线性的。这种非线性的近似公式，显示器通常用 γ(gamma)值来表示。其中 a 是输入的像素值。
$$I_{display}=I_{max}\cdot a^{\gamma}$$
用 γ 描述显示器的非线性只是一个近似值，在估计一个装置的 γ 时，我们不需要很高的精度，一般用中灰来计算。

> 常见的色彩范围是 0-255，所以输入的像素值并非 0 到 1 之间的任何数字，而是离散的$\,{i} \,/\, {255}\,$。

## 3.3 RGB 色彩

大多数计算机图形图像是用 RGB 颜色定义的。RGB 颜色是一个简单的空间，允许直接转换为大多数计算机屏幕的控制。RGB 颜色空间的基本思想是通过混合三种原色来显示颜色。这些光以一种相加的方式混合。
![](pic/Pasted%20image%2020240229151152.png)
将 RGB 作为基本坐标轴，所有色彩都能够在空间中表示：
![](pic/Pasted%20image%2020240229151301.png)
实际的 RGB 等级通常以量化的形式给出，就像灰度级一样。每个分量都用一个整数指定。这些整数最常见的大小是一个字节，因此三个 RGB 分量中的每一个都是介于 0 和 255 之间的整数。这三个整数加在一起占据三个字节，即 24 位。因此，一个具有‘24 位颜色’的系统对于三种原色中的每一个都有 256 个可能的等级。伽马校正问题也分别适用于每个 RGB 分量。

## 3.4 Alpha 合成

通常，我们只希望部分覆盖像素的内容。例如，我们有一个背景，想要在它上面插入一个前景图像。对于前景中的不透明像素，我们只需替换背景像素。对于完全透明的前景像素，我们不改变背景像素。
而对于部分透明的像素，必须小心。当前景对象具有部分透明区域(如玻璃)时，可能出现部分透明像素。但是，前景和背景混合的最常见情况是前景对象仅部分覆盖像素，或者在前景对象的边缘，或者当存在亚像素孔时，例如在远处树木的叶子之间。

将前景对象与背景对象混合所需的最重要的信息是像素覆盖率，它告诉我们前景层覆盖的像素的比例。我们称这个分数为 α，混合遵循一下公式：
$$c = \alpha \cdot c_f +(1-\alpha)\cdot c_b$$
对于不透明前景层，插值是前景对象覆盖像素的矩形内的区域 a，而背景对象覆盖剩余区域，即(1-a)。对于半透明前景层(考虑使用半透明涂料在玻璃或描绘纸上绘制的图像)，插值是前景层阻挡来自背景的光的一部分，并且贡献其自身颜色。
![](pic/Pasted%20image%2020240229152819.png)
图像中所有像素的 alpha 值可以存储在单独的灰度图像中，也可以将信息存储为 RGB 图像中的第四个通道，在这种情况下称为 Alpha 通道，图像可以称为 RGBA 图像。对于 8 位图像，每个像素占用 32 位，这在许多计算机体系结构中是一个方便的大小块。

### 3.4.1 图像存储

大多数 RGB 图像格式对红、绿、蓝通道各使用 8 位。这导致一张百万像素的图像大约有 3 兆字节的原始信息。为了减少存储需求，大多数图像格式都允许某种形式的压缩。这种压缩要么是无损的，要么是有损的。在无损压缩中没有信息被丢弃，而在有损系统中有些信息丢失是不可恢复的。常用的图像存储格式包括：

1. jpeg：这种有损格式基于人类视觉系统中的阈值压缩图像块。适用于自然图像。
2. tiff：这种格式最常用于保存二进制图像或无损压缩的 8 位或 16 位 RGB。
3. ppm：这种非常简单的无损、未压缩格式最常用于 8 位 RGB 图像。
4. png：这是一组无损格式和一组优秀的开源管理工具。

由于压缩和各种格式的变体，可能涉及到为图像编写输入/输出例程。幸运的是，通常可以依赖库例程来读取和写入标准文件格式。对于“快而脏”的应用程序，简单性比效率更重要，一个简单的选择是使用原始 ppm 文件，通常只需将存储在内存中的图像的数组转储到文件中，并加上适当的标题即可编写原始 ppm 文件。
